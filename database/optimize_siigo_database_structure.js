// Configurar variables de entorno
process.env.NODE_ENV = 'development';

const { query } = require('../backend/config/database');

console.log('üîß OPTIMIZANDO ESTRUCTURA DE BASE DE DATOS PARA SIIGO');

async function optimizeSiigoDatabaseStructure() {
  try {
    console.log('\n1Ô∏è‚É£ ANALIZANDO ESTRUCTURA ACTUAL...');
    
    // Verificar estructura actual de orders
    console.log('\nüìã Verificando tabla ORDERS...');
    const ordersStructure = await query('DESCRIBE orders');
    console.log('üìä Columnas actuales en orders:');
    ordersStructure.forEach(col => {
      console.log(`  - ${col.Field}: ${col.Type} (${col.Null === 'YES' ? 'NULL' : 'NOT NULL'})`);
    });
    
    // Verificar estructura actual de order_items
    console.log('\nüì¶ Verificando tabla ORDER_ITEMS...');
    const itemsStructure = await query('DESCRIBE order_items');
    console.log('üìä Columnas actuales en order_items:');
    itemsStructure.forEach(col => {
      console.log(`  - ${col.Field}: ${col.Type} (${col.Null === 'YES' ? 'NULL' : 'NOT NULL'})`);
    });
    
    console.log('\n2Ô∏è‚É£ OPTIMIZANDO TABLA ORDERS PARA SIIGO...');
    
    // Agregar/optimizar campos espec√≠ficos para SIIGO
    const orderOptimizations = [
      {
        field: 'customer_identification',
        sql: 'ADD COLUMN customer_identification VARCHAR(50) NULL AFTER customer_name',
        description: 'N√∫mero de identificaci√≥n/NIT del cliente'
      },
      {
        field: 'customer_id_type',
        sql: 'ADD COLUMN customer_id_type VARCHAR(50) NULL AFTER customer_identification',
        description: 'Tipo de identificaci√≥n (C√©dula, NIT, etc.)'
      },
      {
        field: 'siigo_customer_id',
        sql: 'ADD COLUMN siigo_customer_id VARCHAR(255) NULL AFTER customer_id_type',
        description: 'ID del cliente en SIIGO'
      },
      {
        field: 'customer_person_type',
        sql: 'ADD COLUMN customer_person_type ENUM("Person", "Company") NULL AFTER siigo_customer_id',
        description: 'Tipo de persona (f√≠sica o jur√≠dica)'
      },
      {
        field: 'customer_country',
        sql: 'ADD COLUMN customer_country VARCHAR(100) DEFAULT "Colombia" AFTER customer_department',
        description: 'Pa√≠s del cliente'
      },
      {
        field: 'siigo_observations',
        sql: 'MODIFY COLUMN siigo_observations TEXT NULL',
        description: 'Ampliar campo para observaciones completas'
      },
      {
        field: 'siigo_payment_info',
        sql: 'ADD COLUMN siigo_payment_info JSON NULL AFTER siigo_observations',
        description: 'Informaci√≥n completa de pagos de SIIGO'
      },
      {
        field: 'siigo_seller_id',
        sql: 'ADD COLUMN siigo_seller_id INT NULL AFTER siigo_payment_info',
        description: 'ID del vendedor en SIIGO'
      },
      {
        field: 'siigo_balance',
        sql: 'ADD COLUMN siigo_balance DECIMAL(15,2) NULL AFTER siigo_seller_id',
        description: 'Saldo pendiente en SIIGO'
      },
      {
        field: 'siigo_document_type',
        sql: 'ADD COLUMN siigo_document_type VARCHAR(50) NULL AFTER siigo_balance',
        description: 'Tipo de documento en SIIGO'
      },
      {
        field: 'siigo_stamp_status',
        sql: 'ADD COLUMN siigo_stamp_status VARCHAR(50) NULL AFTER siigo_document_type',
        description: 'Estado del sello/timbrado'
      },
      {
        field: 'siigo_mail_status',
        sql: 'ADD COLUMN siigo_mail_status VARCHAR(50) NULL AFTER siigo_stamp_status',
        description: 'Estado del env√≠o por correo'
      },
      {
        field: 'siigo_public_url',
        sql: 'ADD COLUMN siigo_public_url TEXT NULL AFTER siigo_mail_status',
        description: 'URL p√∫blica del documento en SIIGO'
      }
    ];
    
    // Aplicar optimizaciones a orders
    for (const opt of orderOptimizations) {
      try {
        // Verificar si la columna ya existe
        const columnExists = ordersStructure.some(col => col.Field === opt.field);
        
        if (!columnExists) {
          console.log(`üìù Agregando columna: ${opt.field} - ${opt.description}`);
          await query(`ALTER TABLE orders ${opt.sql}`);
          console.log(`‚úÖ Columna ${opt.field} agregada exitosamente`);
        } else if (opt.sql.includes('MODIFY')) {
          console.log(`üìù Modificando columna: ${opt.field} - ${opt.description}`);
          await query(`ALTER TABLE orders ${opt.sql}`);
          console.log(`‚úÖ Columna ${opt.field} modificada exitosamente`);
        } else {
          console.log(`‚ö™ Columna ${opt.field} ya existe`);
        }
      } catch (error) {
        console.log(`‚ö†Ô∏è Error con columna ${opt.field}: ${error.message}`);
      }
    }
    
    console.log('\n3Ô∏è‚É£ OPTIMIZANDO TABLA ORDER_ITEMS PARA SIIGO...');
    
    // Agregar/optimizar campos espec√≠ficos para items de SIIGO
    const itemOptimizations = [
      {
        field: 'siigo_item_id',
        sql: 'ADD COLUMN siigo_item_id VARCHAR(255) NULL AFTER product_code',
        description: 'ID √∫nico del item en SIIGO'
      },
      {
        field: 'warehouse_id',
        sql: 'ADD COLUMN warehouse_id INT NULL AFTER siigo_item_id',
        description: 'ID del almac√©n en SIIGO'
      },
      {
        field: 'warehouse_name',
        sql: 'ADD COLUMN warehouse_name VARCHAR(100) NULL AFTER warehouse_id',
        description: 'Nombre del almac√©n'
      },
      {
        field: 'tax_info',
        sql: 'ADD COLUMN tax_info JSON NULL AFTER warehouse_name',
        description: 'Informaci√≥n completa de impuestos'
      },
      {
        field: 'item_total',
        sql: 'ADD COLUMN item_total DECIMAL(15,2) NULL AFTER tax_info',
        description: 'Total del item (precio + impuestos)'
      },
      {
        field: 'discount_value',
        sql: 'ADD COLUMN discount_value DECIMAL(15,2) DEFAULT 0 AFTER item_total',
        description: 'Valor de descuento aplicado'
      },
      {
        field: 'unit_price_without_tax',
        sql: 'ADD COLUMN unit_price_without_tax DECIMAL(15,2) NULL AFTER discount_value',
        description: 'Precio unitario sin impuestos'
      }
    ];
    
    // Aplicar optimizaciones a order_items
    for (const opt of itemOptimizations) {
      try {
        // Verificar si la columna ya existe
        const columnExists = itemsStructure.some(col => col.Field === opt.field);
        
        if (!columnExists) {
          console.log(`üì¶ Agregando columna: ${opt.field} - ${opt.description}`);
          await query(`ALTER TABLE order_items ${opt.sql}`);
          console.log(`‚úÖ Columna ${opt.field} agregada exitosamente`);
        } else {
          console.log(`‚ö™ Columna ${opt.field} ya existe`);
        }
      } catch (error) {
        console.log(`‚ö†Ô∏è Error con columna ${opt.field}: ${error.message}`);
      }
    }
    
    console.log('\n4Ô∏è‚É£ VERIFICANDO √çNDICES PARA RENDIMIENTO...');
    
    // Crear √≠ndices para mejorar rendimiento en consultas SIIGO
    const indexes = [
      {
        name: 'idx_siigo_invoice_id',
        table: 'orders',
        sql: 'CREATE INDEX idx_siigo_invoice_id ON orders (siigo_invoice_id)',
        description: '√çndice para b√∫squedas por ID de factura SIIGO'
      },
      {
        name: 'idx_siigo_customer_id', 
        table: 'orders',
        sql: 'CREATE INDEX idx_siigo_customer_id ON orders (siigo_customer_id)',
        description: '√çndice para b√∫squedas por ID de cliente SIIGO'
      },
      {
        name: 'idx_customer_identification',
        table: 'orders',
        sql: 'CREATE INDEX idx_customer_identification ON orders (customer_identification)',
        description: '√çndice para b√∫squedas por identificaci√≥n de cliente'
      },
      {
        name: 'idx_siigo_item_id',
        table: 'order_items',
        sql: 'CREATE INDEX idx_siigo_item_id ON order_items (siigo_item_id)',
        description: '√çndice para b√∫squedas por ID de item SIIGO'
      },
      {
        name: 'idx_product_code',
        table: 'order_items', 
        sql: 'CREATE INDEX idx_product_code ON order_items (product_code)',
        description: '√çndice para b√∫squedas por c√≥digo de producto'
      }
    ];
    
    for (const idx of indexes) {
      try {
        console.log(`üîç Creando √≠ndice: ${idx.name} - ${idx.description}`);
        await query(idx.sql);
        console.log(`‚úÖ √çndice ${idx.name} creado exitosamente`);
      } catch (error) {
        if (error.message.includes('already exists') || error.message.includes('Duplicate key name')) {
          console.log(`‚ö™ √çndice ${idx.name} ya existe`);
        } else {
          console.log(`‚ö†Ô∏è Error creando √≠ndice ${idx.name}: ${error.message}`);
        }
      }
    }
    
    console.log('\n5Ô∏è‚É£ CREANDO TABLA DE CACHE DE CLIENTES SIIGO...');
    
    // Crear tabla para cachear informaci√≥n de clientes de SIIGO
    try {
      await query(`
        CREATE TABLE IF NOT EXISTS siigo_customers_cache (
          id INT AUTO_INCREMENT PRIMARY KEY,
          siigo_customer_id VARCHAR(255) NOT NULL UNIQUE,
          customer_data JSON NOT NULL,
          last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
          INDEX idx_siigo_customer_id (siigo_customer_id),
          INDEX idx_last_updated (last_updated)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
      `);
      console.log('‚úÖ Tabla siigo_customers_cache verificada/creada');
    } catch (error) {
      console.log('‚ö†Ô∏è Error con tabla siigo_customers_cache:', error.message);
    }
    
    console.log('\n6Ô∏è‚É£ CREANDO TABLA DE CACHE DE PRODUCTOS SIIGO...');
    
    // Crear tabla para cachear informaci√≥n de productos de SIIGO
    try {
      await query(`
        CREATE TABLE IF NOT EXISTS siigo_products_cache (
          id INT AUTO_INCREMENT PRIMARY KEY,
          siigo_item_id VARCHAR(255) NOT NULL UNIQUE,
          product_code VARCHAR(100) NOT NULL,
          product_data JSON NOT NULL,
          last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
          INDEX idx_siigo_item_id (siigo_item_id),
          INDEX idx_product_code (product_code),
          INDEX idx_last_updated (last_updated)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
      `);
      console.log('‚úÖ Tabla siigo_products_cache verificada/creada');
    } catch (error) {
      console.log('‚ö†Ô∏è Error con tabla siigo_products_cache:', error.message);
    }
    
    console.log('\n7Ô∏è‚É£ VERIFICANDO ESTRUCTURA FINAL...');
    
    // Verificar estructura final
    const finalOrdersStructure = await query('DESCRIBE orders');
    const finalItemsStructure = await query('DESCRIBE order_items');
    
    console.log(`\nüìä TABLA ORDERS - ${finalOrdersStructure.length} columnas:`);
    finalOrdersStructure.forEach(col => {
      if (col.Field.includes('siigo') || col.Field.includes('customer')) {
        console.log(`  ‚úÖ ${col.Field}: ${col.Type}`);
      }
    });
    
    console.log(`\nüì¶ TABLA ORDER_ITEMS - ${finalItemsStructure.length} columnas:`);
    finalItemsStructure.forEach(col => {
      if (col.Field.includes('siigo') || col.Field.includes('product') || col.Field.includes('warehouse')) {
        console.log(`  ‚úÖ ${col.Field}: ${col.Type}`);
      }
    });
    
    console.log('\nüéØ ¬°BASE DE DATOS OPTIMIZADA PARA SIIGO!');
    console.log('‚úÖ Todos los campos necesarios para datos ricos de SIIGO est√°n disponibles');
    console.log('‚úÖ √çndices creados para mejorar rendimiento');
    console.log('‚úÖ Tablas de cache implementadas para optimizaci√≥n');
    console.log('‚úÖ La base de datos est√° lista para recibir importaciones completas');
    
  } catch (error) {
    console.error('‚ùå Error optimizando base de datos:', error.message);
    console.error('üìä Stack:', error.stack);
  }
}

optimizeSiigoDatabaseStructure().then(() => {
  console.log('\n‚úÖ Optimizaci√≥n completada');
  process.exit(0);
});
